# Sacred Shifter Messaging - STRIDE Threat Model

This document outlines the top 10 security risks to the Sacred Shifter messaging subsystem, analyzed using the STRIDE framework. Each risk is tied to a specific vulnerability in the current codebase and includes a concrete mitigation strategy.

| ID | STRIDE Category | Risk Description | Likelihood / Impact | Vulnerable Code | Mitigation |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **TM-001** | **S**poofing | Attacker impersonates a user by sending messages appearing to be from them. | High / High | `src/lib/sacredMesh/index.ts:65` | **Implement Persistent Identity (MSG-003):** Generate a stable identity key pair once per user and store it in IndexedDB. All messages must be signed with this key. |
| **TM-002** | **I**nformation Disclosure | Attacker on the same network or with access to the signaling server can read all message content. | High / Critical | `src/lib/sacredMesh/index.ts:92` | **Implement E2E Encryption (MSG-001):** Replace the stubbed crypto with a full X3DH/Signal protocol implementation to ensure forward and future secrecy. |
| **TM-003** | **T**ampering | Attacker alters message content in transit without detection. | High / High | `src/lib/sacredMesh/index.ts:92` | **Implement E2E Encryption (MSG-001):** A proper AEAD (Authenticated Encryption) scheme like AES-GCM, used correctly within a secure session from X3DH, prevents tampering. |
| **TM-004** | **D**enial of Service | Malicious peer floods a user with messages, causing the in-memory queue to fill up and drop legitimate older messages. | Medium / Medium | `src/lib/sacredMesh/router.ts:70` | **Implement Durable Queues (MSG-002):** Move queues to IndexedDB. Implement rate-limiting or a "graylist" for messages from unknown peers to prevent queue-stuffing. |
| **TM-005** | **R**epudiation | A user can plausibly deny having sent a message they authored. | Medium / Medium | `src/lib/sacredMesh/index.ts:65` | **Implement Signing (Part of MSG-003):** With persistent identities, every message must be signed with the sender's private identity key, providing non-repudiation. |
| **TM-006** | **I**nformation Disclosure | User's IP address and other metadata are leaked to all peers via WebRTC channels without explicit consent. | High / Medium | `src/hooks/useWebRTC.tsx` | **Minimize Metadata & Use Relays:** Ensure WebRTC connections are established via a TURN relay by default to mask IP addresses. Only allow direct connections after user consent. |
| **TM-007** | **E**levation of Privilege | A crafted packet from a malicious peer exploits the incomplete packet validation, potentially leading to remote code execution if the packet parsing logic were more complex. | Low / High | `src/lib/sacredMesh/router.ts:89` | **Activate Packet Validation:** The existing `validatePacket` function (`packet.ts:140`) must be called for every incoming packet in the router to check for replay attacks, versioning, and timing issues. |
| **TM-008** | **D**enial of Service | A malicious peer sends a flood of invalid packets, causing high CPU usage from repeated, failing decryption attempts. | Medium / Low | `src/lib/sacredMesh/index.ts:119` | **Implement Pre-Decryption Auth:** Before attempting full decryption, verify the message signature against the known public key of the sender. If the signature is invalid, drop the packet immediately. |
| **TM-009** | **S**poofing | A malicious actor could set up a rogue signaling server (for WebSockets/WebRTC) and perform a Man-in-the-Middle (MITM) attack. | Low / Critical | `src/lib/sacredMesh/index.ts:167` | **Use Certificate Pinning & Key Verification:** The WebSocket URL should be fixed. In a native app context, certificate pinning should be used. For web, key transparency/verification UI is crucial. |
| **TM-010** | **I**nformation Disclosure | Sensitive message content or keys are logged to the console in development builds, which could be exposed accidentally. | High / Medium | (Entire codebase) | **Implement Structured Logging (MSG-008):** Replace all `console.log` statements with a structured logger that redacts sensitive fields by default. |
